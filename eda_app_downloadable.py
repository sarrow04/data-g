# -*- coding: utf-8 -*-
"""eda_app_downloadable

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1Hg5CD_2yS7loy2pdd0JpMuyyBbyCKqhQ
"""

import streamlit as st
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import numpy as np
import io # â–¼â–¼â–¼ è¿½åŠ  â–¼â–¼â–¼

# æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã®æ–‡å­—åŒ–ã‘å¯¾ç­–
import japanize_matplotlib

# --- Streamlitã‚¢ãƒ—ãƒªã®åŸºæœ¬è¨­å®š ---
st.set_page_config(page_title="å¯¾è©±å‹EDAãƒ„ãƒ¼ãƒ«", page_icon="ğŸ“Š", layout="wide")
st.title("ğŸ“Š å¯¾è©±å‹ æ¢ç´¢çš„ãƒ‡ãƒ¼ã‚¿åˆ†æï¼ˆEDAï¼‰ãƒ„ãƒ¼ãƒ«")

# --- Session Stateã®åˆæœŸåŒ– ---
if 'df' not in st.session_state:
    st.session_state.df = None

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ ---
with st.sidebar:
    st.header("1. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
    uploaded_file = st.file_uploader("CSVã¾ãŸã¯Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", type=['csv', 'xlsx'])

    if uploaded_file is not None:
        try:
            if uploaded_file.name.endswith('.csv'):
                df = pd.read_csv(uploaded_file)
            else:
                df = pd.read_excel(uploaded_file)
            st.session_state.df = df
            st.success("ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸï¼")
        except Exception as e:
            st.error(f"ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")

# --- ãƒ¡ã‚¤ãƒ³ç”»é¢ ---
if st.session_state.df is not None:
    df = st.session_state.df

    tab1, tab2, tab3, tab4 = st.tabs(["ãƒ‡ãƒ¼ã‚¿æ¦‚è¦", "å˜å¤‰é‡åˆ†æ", "äºŒå¤‰é‡åˆ†æ", "ç›¸é–¢åˆ†æ"])

    # --- Tab1: ãƒ‡ãƒ¼ã‚¿æ¦‚è¦ ---
    with tab1:
        st.subheader("ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼")
        st.dataframe(df.head())
        st.subheader("åŸºæœ¬æƒ…å ±")
        st.markdown(f"**è¡Œæ•°:** {df.shape[0]} è¡Œ, **åˆ—æ•°:** {df.shape[1]} åˆ—")
        st.subheader("åŸºæœ¬çµ±è¨ˆé‡")
        st.dataframe(df.describe(include='all'))

    # --- Tab2: å˜å¤‰é‡åˆ†æ ---
    with tab2:
        st.subheader("1ã¤ã®å¤‰æ•°ã®åˆ†å¸ƒã‚’ç¢ºèª")
        selected_col = st.selectbox("åˆ†æã—ãŸã„åˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„", df.columns, key="tab2_select")

        if selected_col:
            st.write(f"**ã€Œ{selected_col}ã€åˆ—ã®åˆ†å¸ƒ**")

            fig, ax = plt.subplots() # ã‚°ãƒ©ãƒ•ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
            file_name = "" # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’åˆæœŸåŒ–

            if pd.api.types.is_numeric_dtype(df[selected_col]):
                sns.histplot(df[selected_col], kde=True, ax=ax)
                ax.set_title(f'{selected_col} ã®ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ')
                file_name = f"histogram_{selected_col}.png"
            else:
                sns.countplot(y=df[selected_col], order=df[selected_col].value_counts().index, ax=ax)
                ax.set_title(f'{selected_col} ã®ã‚«ã‚¦ãƒ³ãƒˆãƒ—ãƒ­ãƒƒãƒˆ')
                file_name = f"countplot_{selected_col}.png"

            st.pyplot(fig) # ã‚°ãƒ©ãƒ•ã‚’è¡¨ç¤º

            # â–¼â–¼â–¼ ä»¥ä¸‹ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ  â–¼â–¼â–¼
            buf = io.BytesIO()
            fig.savefig(buf, format="png")
            st.download_button(
                label="ã‚°ãƒ©ãƒ•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                data=buf.getvalue(),
                file_name=file_name,
                mime="image/png",
            )
            # â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

    # --- Tab3: äºŒå¤‰é‡åˆ†æ ---
    with tab3:
        st.subheader("2ã¤ã®å¤‰æ•°ã®é–¢ä¿‚ã‚’ç¢ºèª")
        plot_type = st.radio("ã‚°ãƒ©ãƒ•ã®ç¨®é¡ã‚’é¸æŠ", ["æ•£å¸ƒå›³", "ç®±ã²ã’å›³"])

        numeric_cols = df.select_dtypes(include=np.number).columns.tolist()
        categorical_cols = df.select_dtypes(include='object').columns.tolist()

        if plot_type == "æ•£å¸ƒå›³":
            st.write("**2ã¤ã®æ•°å€¤å¤‰æ•°ã®é–¢ä¿‚æ€§ï¼ˆç›¸é–¢ï¼‰**ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚")
            x_axis = st.selectbox("Xè»¸ã®å¤‰æ•°ï¼ˆæ•°å€¤ï¼‰", numeric_cols, key="scatter_x")
            y_axis = st.selectbox("Yè»¸ã®å¤‰æ•°ï¼ˆæ•°å€¤ï¼‰", numeric_cols, key="scatter_y")

            if x_axis and y_axis:
                fig, ax = plt.subplots()
                sns.scatterplot(x=df[x_axis], y=df[y_axis], ax=ax)
                ax.set_title(f'{x_axis} ã¨ {y_axis} ã®æ•£å¸ƒå›³')
                st.pyplot(fig)

                # â–¼â–¼â–¼ ä»¥ä¸‹ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ  â–¼â–¼â–¼
                buf = io.BytesIO()
                fig.savefig(buf, format="png")
                st.download_button(
                    label="ã‚°ãƒ©ãƒ•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=buf.getvalue(),
                    file_name=f"scatter_{x_axis}_vs_{y_axis}.png",
                    mime="image/png",
                )
                # â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

        elif plot_type == "ç®±ã²ã’å›³":
            st.write("**ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®æ•°å€¤å¤‰æ•°ã®åˆ†å¸ƒ**ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚")
            cat_axis = st.selectbox("ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°", categorical_cols, key="box_cat")
            num_axis = st.selectbox("æ•°å€¤å¤‰æ•°", numeric_cols, key="box_num")

            if cat_axis and num_axis:
                fig, ax = plt.subplots()
                sns.boxplot(x=df[cat_axis], y=df[num_axis], ax=ax)
                ax.set_title(f'{cat_axis} ã”ã¨ã® {num_axis} ã®åˆ†å¸ƒ')
                plt.xticks(rotation=45)
                st.pyplot(fig)

                # â–¼â–¼â–¼ ä»¥ä¸‹ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ  â–¼â–¼â–¼
                buf = io.BytesIO()
                fig.savefig(buf, format="png")
                st.download_button(
                    label="ã‚°ãƒ©ãƒ•ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                    data=buf.getvalue(),
                    file_name=f"boxplot_{cat_axis}_vs_{num_axis}.png",
                    mime="image/png",
                )
                # â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²

    # --- Tab4: ç›¸é–¢åˆ†æ ---
    with tab4:
        st.subheader("æ•°å€¤ãƒ‡ãƒ¼ã‚¿é–“ã®ç›¸é–¢ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—")
        st.write("æ•°å€¤å¤‰æ•°ã™ã¹ã¦ã®çµ„ã¿åˆã‚ã›ã®ç›¸é–¢ä¿‚æ•°ã‚’è‰²ã§è¡¨ç¾ã—ãŸã‚‚ã®ã§ã™ã€‚")

        numeric_cols = df.select_dtypes(include=np.number).columns
        if len(numeric_cols) > 1:
            corr_matrix = df[numeric_cols].corr()

            fig, ax = plt.subplots(figsize=(12, 10))
            sns.heatmap(corr_matrix, annot=True, cmap='coolwarm', fmt='.2f', ax=ax)
            st.pyplot(fig)

            # â–¼â–¼â–¼ ä»¥ä¸‹ã€ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’è¿½åŠ  â–¼â–¼â–¼
            buf = io.BytesIO()
            fig.savefig(buf, format="png")
            st.download_button(
                label="ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                data=buf.getvalue(),
                file_name="correlation_heatmap.png",
                mime="image/png",
            )
            # â–²â–²â–² ã“ã“ã¾ã§ â–²â–²â–²
        else:
            st.warning("ç›¸é–¢åˆ†æã‚’è¡Œã†ã«ã¯ã€å°‘ãªãã¨ã‚‚2ã¤ä»¥ä¸Šã®æ•°å€¤åˆ—ãŒå¿…è¦ã§ã™ã€‚")

else:
    st.info("ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆCSVã¾ãŸã¯Excelï¼‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚")